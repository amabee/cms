<!DOCTYPE html>
<html lang="en" class="light-style layout-menu-fixed">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
    <title>Appointments - My Clinic</title>
    <meta name="description" content="Manage Appointments" />
    <link rel="stylesheet" href="../assets/vendor/css/core.css" />
    <link rel="stylesheet" href="../assets/css/demo.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css"
    />
    <style>
      /* Make sidebar scrollable */
      .layout-menu {
        overflow-y: auto !important;
        max-height: 100vh;
      }
      .layout-menu .menu-inner {
        overflow-y: auto;
        max-height: calc(100vh - 70px);
      }
      /* Custom scrollbar for sidebar */
      .layout-menu::-webkit-scrollbar,
      .layout-menu .menu-inner::-webkit-scrollbar {
        width: 6px;
      }
      .layout-menu::-webkit-scrollbar-track,
      .layout-menu .menu-inner::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.05);
      }
      .layout-menu::-webkit-scrollbar-thumb,
      .layout-menu .menu-inner::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
      }
      .layout-menu::-webkit-scrollbar-thumb:hover,
      .layout-menu .menu-inner::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.3);
      }
    </style>
  </head>

  <body>
    <div class="layout-wrapper layout-content-navbar">
      <div class="layout-container">
        <!-- Menu (Sidebar) -->
        <aside
          id="layout-menu"
          class="layout-menu menu-vertical menu bg-menu-theme"
        >
          <div class="app-brand demo">
            <a href="dashboard.html" class="app-brand-link">
              <span class="app-brand-logo demo">
                <img
                  src="../assets/img/favicon/logo.png"
                  alt="Logo"
                  width="32"
                />
              </span>
              <span class="app-brand-text demo menu-text fw-bold ms-2"
                >My Clinic</span
              >
            </a>
          </div>
          <div class="menu-inner-shadow"></div>
          <ul class="menu-inner py-1">
            <li class="menu-item">
              <a href="dashboard.html" class="menu-link">
                <i class="menu-icon tf-icons bx bx-home-circle"></i>
                <div>Dashboard</div>
              </a>
            </li>
            <li class="menu-header small text-uppercase">
              <span class="menu-header-text">Management</span>
            </li>
            <li class="menu-item">
              <a href="users.html" class="menu-link">
                <i class="menu-icon tf-icons bx bx-user"></i>
                <div>Users</div>
              </a>
            </li>
            <li class="menu-item">
              <a href="doctors.html" class="menu-link">
                <i class="menu-icon tf-icons bx bx-plus-medical"></i>
                <div>Doctors</div>
              </a>
            </li>
            <li class="menu-item">
              <a href="departments.html" class="menu-link">
                <i class="menu-icon tf-icons bx bx-building"></i>
                <div>Departments</div>
              </a>
            </li>
            <li class="menu-item">
              <a href="staff.html" class="menu-link">
                <i class="menu-icon tf-icons bx bx-briefcase"></i>
                <div>Staff</div>
              </a>
            </li>
            <li class="menu-item">
              <a href="patients.html" class="menu-link">
                <i class="menu-icon tf-icons bx bx-group"></i>
                <div>Patients</div>
              </a>
            </li>
            <li class="menu-header small text-uppercase">
              <span class="menu-header-text">Clinical</span>
            </li>
            <li class="menu-item">
              <a href="medical-records.html" class="menu-link">
                <i class="menu-icon tf-icons bx bx-file-find"></i>
                <div>Medical Records</div>
              </a>
            </li>
            <li class="menu-item active">
              <a href="appointments.html" class="menu-link">
                <i class="menu-icon tf-icons bx bx-calendar"></i>
                <div>Appointments</div>
              </a>
            </li>
            <li class="menu-item">
              <a href="queue.html" class="menu-link">
                <i class="menu-icon tf-icons bx bx-list-ol"></i>
                <div>Queue</div>
              </a>
            </li>
            <li class="menu-header small text-uppercase">
              <span class="menu-header-text">Financial</span>
            </li>
            <li class="menu-item">
              <a href="billing.html" class="menu-link">
                <i class="menu-icon tf-icons bx bx-receipt"></i>
                <div>Billing & Invoices</div>
              </a>
            </li>
            <li class="menu-header small text-uppercase">
              <span class="menu-header-text">Laboratory</span>
            </li>
            <li class="menu-item">
              <a href="lab-tests.html" class="menu-link">
                <i class="menu-icon tf-icons bx bx-test-tube"></i>
                <div>Lab Tests</div>
              </a>
            </li>
            <li class="menu-item">
              <a href="lab-requests.html" class="menu-link">
                <i class="menu-icon tf-icons bx bx-clipboard-plus"></i>
                <div>Lab Requests</div>
              </a>
            </li>
            <li class="menu-header small text-uppercase">
              <span class="menu-header-text">System</span>
            </li>
            <li class="menu-item">
              <a href="settings.html" class="menu-link">
                <i class="menu-icon tf-icons bx bx-cog"></i>
                <div>Settings</div>
              </a>
            </li>
            <li class="menu-item">
              <a href="audit-logs.html" class="menu-link">
                <i class="menu-icon tf-icons bx bx-list-ul"></i>
                <div>Audit Logs</div>
              </a>
            </li>
          </ul>
        </aside>

        <div class="layout-page">
          <nav
            class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme"
            id="layout-navbar"
          >
            <div
              class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none"
            >
              <a
                class="nav-item nav-link px-0 me-xl-4"
                href="javascript:void(0)"
              >
                <i class="bx bx-menu bx-sm"></i>
              </a>
            </div>
            <div
              class="navbar-nav-right d-flex align-items-center"
              id="navbar-collapse"
            >
              <div class="navbar-nav align-items-center">
                <div class="nav-item d-flex align-items-center">
                  <i class="bx bx-search fs-4 lh-0"></i>
                  <input
                    type="text"
                    class="form-control border-0 shadow-none"
                    placeholder="Search..."
                  />
                </div>
              </div>
              <ul class="navbar-nav flex-row align-items-center ms-auto">
                <li
                  class="nav-item navbar-dropdown dropdown-notifications dropdown me-3 me-xl-2"
                >
                  <a
                    class="nav-link dropdown-toggle hide-arrow"
                    href="javascript:void(0);"
                  >
                    <i class="bx bx-bell bx-sm"></i>
                    <span
                      class="badge bg-danger rounded-pill badge-notifications"
                      id="notificationBadge"
                      >0</span
                    >
                  </a>
                </li>
                <li class="nav-item navbar-dropdown dropdown-user dropdown">
                  <a
                    class="nav-link dropdown-toggle hide-arrow"
                    href="javascript:void(0);"
                    data-bs-toggle="dropdown"
                  >
                    <div class="avatar avatar-online">
                      <span
                        class="avatar-initial rounded-circle bg-label-primary"
                        id="userAvatar"
                        >A</span
                      >
                    </div>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                      <a class="dropdown-item" href="profile.html">
                        <div class="d-flex">
                          <div class="flex-shrink-0 me-3">
                            <div class="avatar avatar-online">
                              <span
                                class="avatar-initial rounded-circle bg-label-primary"
                                id="userAvatarDropdown"
                                >A</span
                              >
                            </div>
                          </div>
                          <div class="flex-grow-1">
                            <span class="fw-semibold d-block" id="userFullName"
                              >User</span
                            >
                            <small class="text-muted" id="userRole"
                              >Admin</small
                            >
                          </div>
                        </div>
                      </a>
                    </li>
                    <li><div class="dropdown-divider"></div></li>
                    <li>
                      <a class="dropdown-item" href="profile.html">
                        <i class="bx bx-user me-2"></i>
                        <span class="align-middle">My Profile</span>
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item" href="settings.html">
                        <i class="bx bx-cog me-2"></i>
                        <span class="align-middle">Settings</span>
                      </a>
                    </li>
                    <li><div class="dropdown-divider"></div></li>
                    <li>
                      <a
                        class="dropdown-item"
                        href="javascript:void(0);"
                        id="logoutBtn"
                      >
                        <i class="bx bx-power-off me-2"></i>
                        <span class="align-middle">Log Out</span>
                      </a>
                    </li>
                  </ul>
                </li>
              </ul>
            </div>
          </nav>

          <div class="content-wrapper">
            <div class="container-xxl flex-grow-1 container-p-y">
              <h4 class="fw-bold py-3 mb-4">
                <span class="text-muted fw-light">Clinical /</span> Appointments
              </h4>

              <!-- Statistics Cards -->
              <div class="row mb-4">
                <div class="col-lg-3 col-md-6 col-sm-6 mb-4">
                  <div class="card">
                    <div class="card-body">
                      <div class="d-flex justify-content-between">
                        <div class="card-info">
                          <p class="card-text">Total</p>
                          <div class="d-flex align-items-end mb-2">
                            <h4
                              class="card-title mb-0 me-2"
                              id="totalAppointments"
                            >
                              0
                            </h4>
                          </div>
                        </div>
                        <div class="card-icon">
                          <span class="badge bg-label-primary rounded p-2">
                            <i class="bx bx-calendar bx-sm"></i>
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 mb-4">
                  <div class="card">
                    <div class="card-body">
                      <div class="d-flex justify-content-between">
                        <div class="card-info">
                          <p class="card-text">Today</p>
                          <div class="d-flex align-items-end mb-2">
                            <h4
                              class="card-title mb-0 me-2"
                              id="todayAppointments"
                            >
                              0
                            </h4>
                          </div>
                        </div>
                        <div class="card-icon">
                          <span class="badge bg-label-info rounded p-2">
                            <i class="bx bx-time-five bx-sm"></i>
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 mb-4">
                  <div class="card">
                    <div class="card-body">
                      <div class="d-flex justify-content-between">
                        <div class="card-info">
                          <p class="card-text">Pending</p>
                          <div class="d-flex align-items-end mb-2">
                            <h4
                              class="card-title mb-0 me-2"
                              id="pendingAppointments"
                            >
                              0
                            </h4>
                          </div>
                        </div>
                        <div class="card-icon">
                          <span class="badge bg-label-warning rounded p-2">
                            <i class="bx bx-hourglass bx-sm"></i>
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 mb-4">
                  <div class="card">
                    <div class="card-body">
                      <div class="d-flex justify-content-between">
                        <div class="card-info">
                          <p class="card-text">Confirmed</p>
                          <div class="d-flex align-items-end mb-2">
                            <h4
                              class="card-title mb-0 me-2"
                              id="confirmedAppointments"
                            >
                              0
                            </h4>
                          </div>
                        </div>
                        <div class="card-icon">
                          <span class="badge bg-label-success rounded p-2">
                            <i class="bx bx-check-circle bx-sm"></i>
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Appointments Table Card -->
              <div class="card">
                <div
                  class="card-header d-flex justify-content-between align-items-center"
                >
                  <h5 class="mb-0">Appointments List</h5>
                  <button
                    type="button"
                    class="btn btn-primary"
                    onclick="openAddModal()"
                  >
                    <i class="bx bx-plus me-1"></i> Add Appointment
                  </button>
                </div>
                <div class="card-body">
                  <div class="row mb-3">
                    <div class="col-md-3">
                      <input
                        type="text"
                        class="form-control"
                        id="searchInput"
                        placeholder="Search..."
                        onkeyup="searchAppointments()"
                      />
                    </div>
                    <div class="col-md-2">
                      <select
                        class="form-select"
                        id="statusFilter"
                        onchange="loadAppointments()"
                      >
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <input
                        type="date"
                        class="form-control"
                        id="dateFilter"
                        onchange="loadAppointments()"
                      />
                    </div>
                    <div class="col-md-2">
                      <select
                        class="form-select"
                        id="doctorFilter"
                        onchange="loadAppointments()"
                      >
                        <option value="">All Doctors</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <select
                        class="form-select"
                        id="patientFilter"
                        onchange="loadAppointments()"
                      >
                        <option value="">All Patients</option>
                      </select>
                    </div>
                    <div class="col-md-1">
                      <button
                        class="btn btn-outline-secondary w-100"
                        onclick="resetFilters()"
                      >
                        <i class="bx bx-reset"></i>
                      </button>
                    </div>
                  </div>
                  <div class="table-responsive text-nowrap">
                    <table class="table">
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Patient</th>
                          <th>Doctor</th>
                          <th>Date & Time</th>
                          <th>Reason</th>
                          <th>Status</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody id="appointmentsTableBody">
                        <tr>
                          <td colspan="7" class="text-center">Loading...</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div
                    class="d-flex justify-content-between align-items-center mt-3"
                  >
                    <div>
                      <span class="text-muted" id="appointmentsInfo"
                        >Showing 0 appointments</span
                      >
                    </div>
                    <nav aria-label="Page navigation">
                      <ul
                        class="pagination pagination-sm mb-0"
                        id="pagination"
                      ></ul>
                    </nav>
                  </div>
                </div>
              </div>
            </div>

            <footer class="content-footer footer bg-footer-theme">
              <div
                class="container-xxl d-flex flex-wrap justify-content-between py-2 flex-md-row flex-column"
              >
                <div class="mb-2 mb-md-0">
                  Â©
                  <script>
                    document.write(new Date().getFullYear());
                  </script>
                  My Clinic CMS
                </div>
              </div>
            </footer>
            <div class="content-backdrop fade"></div>
          </div>
        </div>
      </div>
      <div class="layout-overlay layout-menu-toggle"></div>
    </div>

    <!-- Add Appointment Modal -->
    <div
      class="modal fade"
      id="addAppointmentModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Appointment</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addAppointmentForm">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label"
                    >Patient <span class="text-danger">*</span></label
                  >
                  <select class="form-select" id="addPatientId" required>
                    <option value="">Select Patient</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label"
                    >Doctor <span class="text-danger">*</span></label
                  >
                  <select class="form-select" id="addDoctorId" required>
                    <option value="">Select Doctor</option>
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label"
                    >Appointment Date <span class="text-danger">*</span></label
                  >
                  <input
                    type="date"
                    class="form-control"
                    id="addAppointmentDate"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label"
                    >Appointment Time <span class="text-danger">*</span></label
                  >
                  <input
                    type="time"
                    class="form-control"
                    id="addAppointmentTime"
                    required
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label"
                  >Status <span class="text-danger">*</span></label
                >
                <select class="form-select" id="addStatus" required>
                  <option value="pending">Pending</option>
                  <option value="confirmed">Confirmed</option>
                  <option value="completed">Completed</option>
                  <option value="cancelled">Cancelled</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label"
                  >Reason <span class="text-danger">*</span></label
                >
                <textarea
                  class="form-control"
                  id="addReason"
                  rows="3"
                  placeholder="Enter reason for appointment..."
                  required
                ></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Notes</label>
                <textarea
                  class="form-control"
                  id="addNotes"
                  rows="2"
                  placeholder="Additional notes..."
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-outline-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveAppointment()"
            >
              Save Appointment
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Appointment Modal -->
    <div
      class="modal fade"
      id="editAppointmentModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Appointment</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editAppointmentForm">
              <input type="hidden" id="editAppointmentId" />
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label"
                    >Patient <span class="text-danger">*</span></label
                  >
                  <select class="form-select" id="editPatientId" required>
                    <option value="">Select Patient</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label"
                    >Doctor <span class="text-danger">*</span></label
                  >
                  <select class="form-select" id="editDoctorId" required>
                    <option value="">Select Doctor</option>
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label"
                    >Appointment Date <span class="text-danger">*</span></label
                  >
                  <input
                    type="date"
                    class="form-control"
                    id="editAppointmentDate"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label"
                    >Appointment Time <span class="text-danger">*</span></label
                  >
                  <input
                    type="time"
                    class="form-control"
                    id="editAppointmentTime"
                    required
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label"
                  >Status <span class="text-danger">*</span></label
                >
                <select class="form-select" id="editStatus" required>
                  <option value="pending">Pending</option>
                  <option value="confirmed">Confirmed</option>
                  <option value="completed">Completed</option>
                  <option value="cancelled">Cancelled</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label"
                  >Reason <span class="text-danger">*</span></label
                >
                <textarea
                  class="form-control"
                  id="editReason"
                  rows="3"
                  required
                ></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Notes</label>
                <textarea
                  class="form-control"
                  id="editNotes"
                  rows="2"
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-outline-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="updateAppointment()"
            >
              Update Appointment
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- View Appointment Modal -->
    <div
      class="modal fade"
      id="viewAppointmentModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Appointment Details</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <p class="mb-1"><strong>Appointment ID:</strong></p>
                <p id="viewAppointmentId" class="text-muted">-</p>
              </div>
              <div class="col-md-6">
                <p class="mb-1"><strong>Status:</strong></p>
                <p id="viewStatus" class="text-muted">-</p>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <p class="mb-1"><strong>Patient:</strong></p>
                <p id="viewPatient" class="text-muted">-</p>
              </div>
              <div class="col-md-6">
                <p class="mb-1"><strong>Doctor:</strong></p>
                <p id="viewDoctor" class="text-muted">-</p>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <p class="mb-1"><strong>Date:</strong></p>
                <p id="viewDate" class="text-muted">-</p>
              </div>
              <div class="col-md-6">
                <p class="mb-1"><strong>Time:</strong></p>
                <p id="viewTime" class="text-muted">-</p>
              </div>
            </div>
            <div class="mb-3">
              <p class="mb-1"><strong>Reason:</strong></p>
              <p id="viewReason" class="text-muted">-</p>
            </div>
            <div class="mb-3">
              <p class="mb-1"><strong>Notes:</strong></p>
              <p id="viewNotes" class="text-muted">-</p>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-outline-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="../assets/vendor/js/bootstrap.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../assets/js/session-handler.js"></script>

    <script>
      (function () {
        "use strict";
        if (!SessionHandler.requireUserType(1)) return;

        var user = SessionHandler.getUser();
        var fullName = SessionHandler.getUserFullName();
        var initials = fullName
          .split(" ")
          .map((n) => n[0])
          .join("")
          .toUpperCase()
          .substring(0, 2);

        document.getElementById("userFullName").textContent = fullName;
        document.getElementById("userRole").textContent =
          SessionHandler.getUserRole();
        document.getElementById("userAvatar").textContent = initials;
        document.getElementById("userAvatarDropdown").textContent = initials;

        var notifCount = SessionHandler.getUnreadNotificationsCount();
        document.getElementById("notificationBadge").textContent = notifCount;
        if (notifCount === 0)
          document.getElementById("notificationBadge").style.display = "none";

        document
          .getElementById("logoutBtn")
          .addEventListener("click", function (e) {
            e.preventDefault();
            if (confirm("Are you sure you want to logout?"))
              SessionHandler.logout();
          });

        var menuToggle = document.querySelector(".layout-menu-toggle");
        if (menuToggle) {
          menuToggle.addEventListener("click", function () {
            document
              .querySelector(".layout-wrapper")
              .classList.toggle("layout-menu-expanded");
          });
        }

        const API_BASE = "../../backend/";
        let currentPage = 1;
        let appointmentsPerPage = 10;
        let allPatients = [];
        let allDoctors = [];

        // Initialize page
        loadStatistics();
        loadAppointments();
        loadPatients();
        loadDoctors();

        // Set default date to today
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("addAppointmentDate").value = today;
        document
          .getElementById("addAppointmentDate")
          .setAttribute("min", today);

        // Load statistics
        async function loadStatistics() {
          try {
            const response = await axios.post(API_BASE + "appointments.php", {
              action: "getStatistics",
            });

            console.log("Statistics response:", response.data);

            if (response.data.success) {
              const stats = response.data.data;
              console.log("Stats object:", stats);

              document.getElementById("totalAppointments").textContent =
                stats.total_appointments || 0;
              document.getElementById("todayAppointments").textContent =
                stats.today_appointments || 0;
              document.getElementById("pendingAppointments").textContent =
                stats.pending_appointments || 0;
              document.getElementById("confirmedAppointments").textContent =
                stats.confirmed_appointments || 0;

              console.log("Statistics updated successfully");
            }
          } catch (error) {
            console.error("Error loading statistics:", error);
          }
        }

        // Load appointments
        async function loadAppointments() {
          try {
            const search = document.getElementById("searchInput").value;
            const status = document.getElementById("statusFilter").value;
            const dateFilter = document.getElementById("dateFilter").value;
            const doctorFilter = document.getElementById("doctorFilter").value;
            const patientFilter =
              document.getElementById("patientFilter").value;

            const response = await axios.post(API_BASE + "appointments.php", {
              action: "getAll",
              page: currentPage,
              limit: appointmentsPerPage,
              search: search,
              status: status,
              date_filter: dateFilter,
              doctor_id: doctorFilter,
              patient_id: patientFilter,
            });

            if (response.data.success) {
              displayAppointments(response.data.appointments);
              updatePagination(
                response.data.total,
                response.data.page,
                response.data.totalPages
              );
            }
          } catch (error) {
            console.error("Error loading appointments:", error);
            showError("Failed to load appointments");
          }
        }

        // Display appointments in table
        function displayAppointments(appointments) {
          const tbody = document.getElementById("appointmentsTableBody");

          if (appointments.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="7" class="text-center">No appointments found</td></tr>';
            return;
          }

          tbody.innerHTML = appointments
            .map((apt) => {
              const statusBadge = getStatusBadge(apt.status);
              return `
            <tr>
              <td><strong>${apt.appointment_id}</strong></td>
              <td>${apt.patient_name || "N/A"}</td>
              <td>Dr. ${apt.doctor_name || "N/A"}</td>
              <td>
                <div>${formatDate(apt.appointment_date)}</div>
                <small class="text-muted">${formatTime(
                  apt.appointment_time
                )}</small>
              </td>
              <td>${
                apt.reason
                  ? apt.reason.substring(0, 40) +
                    (apt.reason.length > 40 ? "..." : "")
                  : "N/A"
              }</td>
              <td>${statusBadge}</td>
              <td>
                <div class="dropdown">
                  <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
                    <i class="bx bx-dots-vertical-rounded"></i>
                  </button>
                  <div class="dropdown-menu">
                    <a class="dropdown-item" href="javascript:void(0);" onclick="viewAppointment(${
                      apt.appointment_id
                    })">
                      <i class="bx bx-show me-1"></i> View
                    </a>
                    <a class="dropdown-item" href="javascript:void(0);" onclick="editAppointment(${
                      apt.appointment_id
                    })">
                      <i class="bx bx-edit me-1"></i> Edit
                    </a>
                    ${
                      apt.status === "pending"
                        ? `
                    <a class="dropdown-item" href="javascript:void(0);" onclick="updateStatus(${apt.appointment_id}, 'confirmed')">
                      <i class="bx bx-check me-1"></i> Confirm
                    </a>
                    `
                        : ""
                    }
                    ${
                      apt.status === "confirmed"
                        ? `
                    <a class="dropdown-item" href="javascript:void(0);" onclick="updateStatus(${apt.appointment_id}, 'completed')">
                      <i class="bx bx-check-double me-1"></i> Complete
                    </a>
                    `
                        : ""
                    }
                    ${
                      apt.status !== "cancelled" && apt.status !== "completed"
                        ? `
                    <a class="dropdown-item text-warning" href="javascript:void(0);" onclick="updateStatus(${apt.appointment_id}, 'cancelled')">
                      <i class="bx bx-x me-1"></i> Cancel
                    </a>
                    `
                        : ""
                    }
                    <a class="dropdown-item text-danger" href="javascript:void(0);" onclick="deleteAppointment(${
                      apt.appointment_id
                    })">
                      <i class="bx bx-trash me-1"></i> Delete
                    </a>
                  </div>
                </div>
              </td>
            </tr>
          `;
            })
            .join("");
        }

        // Get status badge
        function getStatusBadge(status) {
          const badges = {
            pending: '<span class="badge bg-label-warning">Pending</span>',
            confirmed: '<span class="badge bg-label-info">Confirmed</span>',
            completed: '<span class="badge bg-label-success">Completed</span>',
            cancelled: '<span class="badge bg-label-danger">Cancelled</span>',
          };
          return (
            badges[status] ||
            '<span class="badge bg-label-secondary">Unknown</span>'
          );
        }

        // Load patients for dropdowns
        async function loadPatients() {
          try {
            const params = new URLSearchParams();
            params.append("operation", "getAll");
            params.append(
              "json",
              JSON.stringify({
                limit: 1000,
              })
            );

            const response = await axios.post(
              API_BASE + "patients.php",
              params
            );

            if (response.data.success) {
              allPatients = response.data.data;
              populatePatientDropdowns();
            }
          } catch (error) {
            console.error("Error loading patients:", error);
          }
        }

        // Populate patient dropdowns
        function populatePatientDropdowns() {
          const selects = ["addPatientId", "editPatientId", "patientFilter"];

          selects.forEach((selectId) => {
            const select = document.getElementById(selectId);
            const isFilter = selectId === "patientFilter";

            select.innerHTML = isFilter
              ? '<option value="">All Patients</option>'
              : '<option value="">Select Patient</option>';

            allPatients.forEach((patient) => {
              const option = document.createElement("option");
              option.value = patient.patient_id;
              option.textContent = `${patient.first_name} ${patient.last_name}`;
              select.appendChild(option);
            });
          });
        }

        // Load doctors for dropdowns
        async function loadDoctors() {
          try {
            const params = new URLSearchParams();
            params.append("operation", "getAll");
            params.append(
              "json",
              JSON.stringify({
                limit: 1000,
              })
            );

            const response = await axios.post(API_BASE + "doctors.php", params);

            if (response.data.success) {
              allDoctors = response.data.data;
              populateDoctorDropdowns();
            }
          } catch (error) {
            console.error("Error loading doctors:", error);
          }
        }

        // Populate doctor dropdowns
        function populateDoctorDropdowns() {
          const selects = ["addDoctorId", "editDoctorId", "doctorFilter"];

          selects.forEach((selectId) => {
            const select = document.getElementById(selectId);
            const isFilter = selectId === "doctorFilter";

            select.innerHTML = isFilter
              ? '<option value="">All Doctors</option>'
              : '<option value="">Select Doctor</option>';

            allDoctors.forEach((doctor) => {
              const option = document.createElement("option");
              option.value = doctor.doctor_id;
              option.textContent = `Dr. ${doctor.first_name} ${doctor.last_name} - ${doctor.specialization}`;
              select.appendChild(option);
            });
          });
        }

        // Open add modal
        function openAddModal() {
          document.getElementById("addAppointmentForm").reset();
          const today = new Date().toISOString().split("T")[0];
          document.getElementById("addAppointmentDate").value = today;
          document.getElementById("addStatus").value = "pending";

          const modal = new bootstrap.Modal(
            document.getElementById("addAppointmentModal")
          );
          modal.show();
        }

        // Save new appointment
        async function saveAppointment() {
          const form = document.getElementById("addAppointmentForm");
          if (!form.checkValidity()) {
            form.reportValidity();
            return;
          }

          const data = {
            action: "create",
            patient_id: document.getElementById("addPatientId").value,
            doctor_id: document.getElementById("addDoctorId").value,
            appointment_date:
              document.getElementById("addAppointmentDate").value,
            appointment_time:
              document.getElementById("addAppointmentTime").value,
            reason: document.getElementById("addReason").value,
            status: document.getElementById("addStatus").value,
            notes: document.getElementById("addNotes").value,
          };

          try {
            const response = await axios.post(
              API_BASE + "appointments.php",
              data
            );

            if (response.data.success) {
              showSuccess("Appointment created successfully");
              bootstrap.Modal.getInstance(
                document.getElementById("addAppointmentModal")
              ).hide();
              loadAppointments();
              loadStatistics();
            } else {
              showError(
                response.data.message || "Failed to create appointment"
              );
            }
          } catch (error) {
            console.error("Error creating appointment:", error);
            showError("Failed to create appointment");
          }
        }

        // View appointment details
        async function viewAppointment(id) {
          try {
            const response = await axios.post(API_BASE + "appointments.php", {
              action: "getById",
              appointment_id: id,
            });

            if (response.data.success) {
              const apt = response.data.appointment;

              document.getElementById("viewAppointmentId").textContent =
                apt.appointment_id;
              document.getElementById("viewStatus").innerHTML = getStatusBadge(
                apt.status
              );
              document.getElementById("viewPatient").textContent =
                apt.patient_name || "N/A";
              document.getElementById("viewDoctor").textContent =
                "Dr. " + (apt.doctor_name || "N/A");
              document.getElementById("viewDate").textContent = formatDate(
                apt.appointment_date
              );
              document.getElementById("viewTime").textContent = formatTime(
                apt.appointment_time
              );
              document.getElementById("viewReason").textContent =
                apt.reason || "N/A";
              document.getElementById("viewNotes").textContent =
                apt.notes || "No additional notes";

              const modal = new bootstrap.Modal(
                document.getElementById("viewAppointmentModal")
              );
              modal.show();
            }
          } catch (error) {
            console.error("Error loading appointment:", error);
            showError("Failed to load appointment details");
          }
        }

        // Edit appointment
        async function editAppointment(id) {
          try {
            const response = await axios.post(API_BASE + "appointments.php", {
              action: "getById",
              appointment_id: id,
            });

            if (response.data.success) {
              const apt = response.data.appointment;

              document.getElementById("editAppointmentId").value =
                apt.appointment_id;
              document.getElementById("editPatientId").value = apt.patient_id;
              document.getElementById("editDoctorId").value = apt.doctor_id;
              document.getElementById("editAppointmentDate").value =
                apt.appointment_date;
              document.getElementById("editAppointmentTime").value =
                apt.appointment_time;
              document.getElementById("editStatus").value = apt.status;
              document.getElementById("editReason").value = apt.reason;
              document.getElementById("editNotes").value = apt.notes || "";

              const modal = new bootstrap.Modal(
                document.getElementById("editAppointmentModal")
              );
              modal.show();
            }
          } catch (error) {
            console.error("Error loading appointment:", error);
            showError("Failed to load appointment details");
          }
        }

        // Update appointment
        async function updateAppointment() {
          const form = document.getElementById("editAppointmentForm");
          if (!form.checkValidity()) {
            form.reportValidity();
            return;
          }

          const data = {
            action: "update",
            appointment_id: document.getElementById("editAppointmentId").value,
            patient_id: document.getElementById("editPatientId").value,
            doctor_id: document.getElementById("editDoctorId").value,
            appointment_date: document.getElementById("editAppointmentDate")
              .value,
            appointment_time: document.getElementById("editAppointmentTime")
              .value,
            reason: document.getElementById("editReason").value,
            status: document.getElementById("editStatus").value,
            notes: document.getElementById("editNotes").value,
          };

          try {
            const response = await axios.post(
              API_BASE + "appointments.php",
              data
            );

            if (response.data.success) {
              showSuccess("Appointment updated successfully");
              bootstrap.Modal.getInstance(
                document.getElementById("editAppointmentModal")
              ).hide();
              loadAppointments();
              loadStatistics();
            } else {
              showError(
                response.data.message || "Failed to update appointment"
              );
            }
          } catch (error) {
            console.error("Error updating appointment:", error);
            showError("Failed to update appointment");
          }
        }

        // Delete appointment
        async function deleteAppointment(id) {
          if (!confirm("Are you sure you want to delete this appointment?")) {
            return;
          }

          try {
            const response = await axios.post(API_BASE + "appointments.php", {
              action: "delete",
              appointment_id: id,
            });

            if (response.data.success) {
              showSuccess("Appointment deleted successfully");
              loadAppointments();
              loadStatistics();
            } else {
              showError(
                response.data.message || "Failed to delete appointment"
              );
            }
          } catch (error) {
            console.error("Error deleting appointment:", error);
            showError("Failed to delete appointment");
          }
        }

        // Update status
        async function updateStatus(id, status) {
          const confirmMessages = {
            confirmed: "Are you sure you want to confirm this appointment?",
            completed:
              "Are you sure you want to mark this appointment as completed?",
            cancelled: "Are you sure you want to cancel this appointment?",
          };

          if (
            !confirm(confirmMessages[status] || "Update appointment status?")
          ) {
            return;
          }

          try {
            const response = await axios.post(API_BASE + "appointments.php", {
              action: "updateStatus",
              appointment_id: id,
              status: status,
            });

            if (response.data.success) {
              showSuccess("Appointment status updated successfully");
              loadAppointments();
              loadStatistics();
            } else {
              showError(response.data.message || "Failed to update status");
            }
          } catch (error) {
            console.error("Error updating status:", error);
            showError("Failed to update appointment status");
          }
        }

        // Search appointments
        function searchAppointments() {
          currentPage = 1;
          loadAppointments();
        }

        // Reset filters
        function resetFilters() {
          document.getElementById("searchInput").value = "";
          document.getElementById("statusFilter").value = "";
          document.getElementById("dateFilter").value = "";
          document.getElementById("doctorFilter").value = "";
          document.getElementById("patientFilter").value = "";
          currentPage = 1;
          loadAppointments();
        }

        // Update pagination
        function updatePagination(total, current, totalPages) {
          const start = (current - 1) * appointmentsPerPage + 1;
          const end = Math.min(current * appointmentsPerPage, total);
          document.getElementById(
            "appointmentsInfo"
          ).textContent = `Showing ${start}-${end} of ${total} appointments`;

          const pagination = document.getElementById("pagination");
          pagination.innerHTML = "";

          if (totalPages <= 1) return;

          // Previous button
          const prevLi = document.createElement("li");
          prevLi.className = `page-item ${current === 1 ? "disabled" : ""}`;
          prevLi.innerHTML = `<a class="page-link" href="javascript:void(0);" onclick="changePage(${
            current - 1
          })">Previous</a>`;
          pagination.appendChild(prevLi);

          // Page numbers
          for (let i = 1; i <= totalPages; i++) {
            if (
              i === 1 ||
              i === totalPages ||
              (i >= current - 1 && i <= current + 1)
            ) {
              const li = document.createElement("li");
              li.className = `page-item ${i === current ? "active" : ""}`;
              li.innerHTML = `<a class="page-link" href="javascript:void(0);" onclick="changePage(${i})">${i}</a>`;
              pagination.appendChild(li);
            } else if (i === current - 2 || i === current + 2) {
              const li = document.createElement("li");
              li.className = "page-item disabled";
              li.innerHTML = '<a class="page-link">...</a>';
              pagination.appendChild(li);
            }
          }

          // Next button
          const nextLi = document.createElement("li");
          nextLi.className = `page-item ${
            current === totalPages ? "disabled" : ""
          }`;
          nextLi.innerHTML = `<a class="page-link" href="javascript:void(0);" onclick="changePage(${
            current + 1
          })">Next</a>`;
          pagination.appendChild(nextLi);
        }

        // Change page
        function changePage(page) {
          currentPage = page;
          loadAppointments();
        }

        // Format date
        function formatDate(dateString) {
          if (!dateString) return "N/A";
          const date = new Date(dateString);
          return date.toLocaleDateString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
          });
        }

        // Format time
        function formatTime(timeString) {
          if (!timeString) return "N/A";
          const [hours, minutes] = timeString.split(":");
          const hour = parseInt(hours);
          const ampm = hour >= 12 ? "PM" : "AM";
          const displayHour = hour % 12 || 12;
          return `${displayHour}:${minutes} ${ampm}`;
        }

        // Show success message
        function showSuccess(message) {
          alert(message);
        }

        // Show error message
        function showError(message) {
          alert(message);
        }

        // Expose functions to global scope for onclick handlers
        window.openAddModal = openAddModal;
        window.saveAppointment = saveAppointment;
        window.viewAppointment = viewAppointment;
        window.editAppointment = editAppointment;
        window.updateAppointment = updateAppointment;
        window.deleteAppointment = deleteAppointment;
        window.updateStatus = updateStatus;
        window.resetFilters = resetFilters;
        window.changePage = changePage;
        window.searchAppointments = searchAppointments;
        window.loadAppointments = loadAppointments;

        console.log("Appointments page loaded");
      })();
    </script>
  </body>
</html>
