<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Requests Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        .badge-requested { background-color: #ffc107; }
        .badge-in-progress { background-color: #0dcaf0; }
        .badge-completed { background-color: #198754; }
        .badge-cancelled { background-color: #6c757d; }
        .badge-urgent { background-color: #dc3545; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .test-item { padding: 8px; border-left: 3px solid #0d6efd; margin-bottom: 8px; background: #f8f9fa; }
    </style>
</head>
<body>
    <div class="d-flex">
        <!-- Sidebar -->
        <nav id="sidebar" class="bg-dark text-white p-3">
            <div class="sidebar-header mb-4">
                <h3>Clinic CMS</h3>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item"><a href="dashboard.html" class="nav-link text-white"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
                <li class="nav-item"><a href="doctors.html" class="nav-link text-white"><i class="bi bi-person-badge"></i> Doctors</a></li>
                <li class="nav-item"><a href="patients.html" class="nav-link text-white"><i class="bi bi-people"></i> Patients</a></li>
                <li class="nav-item"><a href="staff.html" class="nav-link text-white"><i class="bi bi-person-workspace"></i> Staff</a></li>
                <li class="nav-item"><a href="lab-tests.html" class="nav-link text-white"><i class="bi bi-prescription2"></i> Lab Tests</a></li>
                <li class="nav-item"><a href="lab-requests.html" class="nav-link text-white active"><i class="bi bi-clipboard2-pulse"></i> Lab Requests</a></li>
                <li class="nav-item"><a href="departments.html" class="nav-link text-white"><i class="bi bi-building"></i> Departments</a></li>
                <li class="nav-item"><a href="users.html" class="nav-link text-white"><i class="bi bi-person-circle"></i> Users</a></li>
                <li class="nav-item"><a href="settings.html" class="nav-link text-white"><i class="bi bi-gear"></i> Settings</a></li>
                <li class="nav-item"><a href="backup.html" class="nav-link text-white"><i class="bi bi-database"></i> Backup</a></li>
                <li class="nav-item"><a href="audit-logs.html" class="nav-link text-white"><i class="bi bi-clock-history"></i> Audit Logs</a></li>
                <li class="nav-item mt-3"><a href="#" id="logoutBtn" class="nav-link text-danger"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <div class="flex-grow-1">
            <!-- Top Navbar -->
            <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
                <div class="container-fluid">
                    <button class="btn btn-outline-secondary" id="sidebarToggle"><i class="bi bi-list"></i></button>
                    <span class="navbar-brand mb-0 h1">Lab Requests Management</span>
                    <div class="ms-auto">
                        <span class="me-3">Welcome, <strong id="userName">Admin</strong></span>
                    </div>
                </div>
            </nav>

            <!-- Page Content -->
            <div class="container-fluid p-4">
                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-2">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <h6 class="text-muted">Total</h6>
                                <h3 id="statTotal">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card border-info">
                            <div class="card-body text-center">
                                <h6 class="text-muted">Today</h6>
                                <h3 id="statToday">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card border-warning">
                            <div class="card-body text-center">
                                <h6 class="text-muted">Pending</h6>
                                <h3 id="statPending">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card border-info">
                            <div class="card-body text-center">
                                <h6 class="text-muted">In Progress</h6>
                                <h3 id="statInProgress">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h6 class="text-muted">Completed</h6>
                                <h3 id="statCompleted">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card border-danger">
                            <div class="card-body text-center">
                                <h6 class="text-muted">Urgent</h6>
                                <h3 id="statUrgent">0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters and Actions -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row align-items-end">
                            <div class="col-md-3">
                                <label class="form-label">Search</label>
                                <input type="text" class="form-control" id="searchInput" placeholder="Request#, Patient...">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="all">All</option>
                                    <option value="requested">Requested</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Payment</label>
                                <select class="form-select" id="paymentFilter">
                                    <option value="all">All</option>
                                    <option value="unpaid">Unpaid</option>
                                    <option value="paid">Paid</option>
                                    <option value="waived">Waived</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Priority</label>
                                <select class="form-select" id="priorityFilter">
                                    <option value="all">All</option>
                                    <option value="normal">Normal</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                            <div class="col-md-3 text-end">
                                <button class="btn btn-primary" id="addRequestBtn"><i class="bi bi-plus-circle"></i> New Request</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lab Requests Table -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Request #</th>
                                        <th>Patient</th>
                                        <th>Doctor</th>
                                        <th>Tests</th>
                                        <th>Date</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Payment</th>
                                        <th>Cost</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="requestsTableBody">
                                    <tr>
                                        <td colspan="10" class="text-center">
                                            <div class="spinner-border text-primary" role="status"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <nav><ul class="pagination justify-content-center" id="pagination"></ul></nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Request Modal -->
    <div class="modal fade" id="requestModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Lab Request</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="requestForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Patient <span class="text-danger">*</span></label>
                                <select class="form-select" id="patientSelect" required>
                                    <option value="">Select Patient</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Doctor <span class="text-danger">*</span></label>
                                <select class="form-select" id="doctorSelect" required>
                                    <option value="">Select Doctor</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Priority</label>
                                <select class="form-select" id="prioritySelect">
                                    <option value="normal">Normal</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Payment Status</label>
                                <select class="form-select" id="paymentSelect">
                                    <option value="unpaid">Unpaid</option>
                                    <option value="paid">Paid</option>
                                    <option value="waived">Waived</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Total Cost</label>
                                <input type="text" class="form-control" id="totalCost" readonly value="₱0.00">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Select Tests <span class="text-danger">*</span></label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="testSearch" placeholder="Search tests...">
                                <button class="btn btn-outline-secondary" type="button" id="showAllTests">
                                    <i class="bi bi-list"></i> Show All
                                </button>
                            </div>
                            <div id="testsContainer" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                <p class="text-muted">Loading tests...</p>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Selected Tests (<span id="selectedCount">0</span>)</label>
                            <div id="selectedTests" class="border rounded p-3 bg-light" style="min-height: 100px;">
                                <p class="text-muted">No tests selected</p>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Remarks</label>
                            <textarea class="form-control" id="remarks" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveRequestBtn">Create Request</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Request Modal -->
    <div class="modal fade" id="viewModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Lab Request Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="viewModalBody">
                    <div class="text-center"><div class="spinner-border"></div></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="printBtn"><i class="bi bi-printer"></i> Print</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Status Modal -->
    <div class="modal fade" id="updateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Request Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="updateRequestId">
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="updateStatus">
                            <option value="requested">Requested</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Status</label>
                        <select class="form-select" id="updatePayment">
                            <option value="unpaid">Unpaid</option>
                            <option value="paid">Paid</option>
                            <option value="waived">Waived</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="updatePriority">
                            <option value="normal">Normal</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmUpdateBtn">Update</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../assets/js/session-handler.js"></script>
    <script>
        const API_URL = 'http://localhost/cms/backend/lab-requests.php';
        const TESTS_API = 'http://localhost/cms/backend/lab-tests.php';
        const PATIENTS_API = 'http://localhost/cms/backend/patients.php';
        const DOCTORS_API = 'http://localhost/cms/backend/doctors.php';
        
        let currentPage = 1;
        let user = null;
        let allTests = [];
        let selectedTests = new Set();

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            user = SessionHandler.getUser();
            if (!user) {
                window.location.href = '../index.html';
                return;
            }

            document.getElementById('userName').textContent = user.username;
            loadRequests();
            loadStatistics();
            setupEventListeners();
        });

        // Setup Event Listeners
        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', debounce(loadRequests, 500));
            document.getElementById('statusFilter').addEventListener('change', loadRequests);
            document.getElementById('paymentFilter').addEventListener('change', loadRequests);
            document.getElementById('priorityFilter').addEventListener('change', loadRequests);
            document.getElementById('addRequestBtn').addEventListener('click', showAddModal);
            document.getElementById('saveRequestBtn').addEventListener('click', saveRequest);
            document.getElementById('testSearch').addEventListener('input', filterTests);
            document.getElementById('showAllTests').addEventListener('click', () => {
                document.getElementById('testSearch').value = '';
                filterTests();
            });
            document.getElementById('confirmUpdateBtn').addEventListener('click', updateRequestStatus);
            document.getElementById('logoutBtn').addEventListener('click', function() {
                SessionHandler.clearSession();
                window.location.href = '../index.html';
            });
        }

        // Load Statistics
        async function loadStatistics() {
            try {
                const response = await axios.get(API_URL, {
                    params: { operation: 'getStatistics', json: '{}' }
                });

                if (response.data.success) {
                    const stats = response.data.data;
                    document.getElementById('statTotal').textContent = stats.total;
                    document.getElementById('statToday').textContent = stats.today;
                    document.getElementById('statPending').textContent = stats.pending;
                    document.getElementById('statInProgress').textContent = stats.in_progress;
                    document.getElementById('statCompleted').textContent = stats.completed;
                    document.getElementById('statUrgent').textContent = stats.urgent;
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Load Requests
        async function loadRequests() {
            const search = document.getElementById('searchInput').value;
            const status = document.getElementById('statusFilter').value;
            const payment = document.getElementById('paymentFilter').value;
            const priority = document.getElementById('priorityFilter').value;

            try {
                const response = await axios.get(API_URL, {
                    params: {
                        operation: 'getAll',
                        json: JSON.stringify({
                            search, status,
                            payment_status: payment,
                            priority,
                            page: currentPage,
                            limit: 10
                        })
                    }
                });

                if (response.data.success) {
                    renderRequestsTable(response.data.data);
                    renderPagination(response.data.total, response.data.page, response.data.limit);
                }
            } catch (error) {
                showAlert('Error loading requests: ' + error.message, 'danger');
            }
        }

        // Render Requests Table
        function renderRequestsTable(requests) {
            const tbody = document.getElementById('requestsTableBody');
            
            if (requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted"><i class="bi bi-inbox fs-1"></i><p>No requests found</p></td></tr>';
                return;
            }

            tbody.innerHTML = requests.map(req => {
                const statusBadge = `badge-${req.status}`;
                const priorityBadge = req.priority === 'urgent' ? 'badge-urgent' : 'badge-secondary';
                
                return `
                    <tr>
                        <td><strong>${escapeHtml(req.request_no)}</strong></td>
                        <td>
                            ${escapeHtml(req.patient_name)}<br>
                            <small class="text-muted">${escapeHtml(req.patient_code)}</small>
                        </td>
                        <td>
                            ${escapeHtml(req.doctor_name)}<br>
                            <small class="text-muted">${escapeHtml(req.specialization || '')}</small>
                        </td>
                        <td><span class="badge bg-info">${req.items.length} test(s)</span></td>
                        <td>${formatDateTime(req.date_requested)}</td>
                        <td><span class="badge ${priorityBadge}">${req.priority}</span></td>
                        <td><span class="badge ${statusBadge}">${req.status}</span></td>
                        <td><span class="badge ${req.payment_status === 'paid' ? 'bg-success' : 'bg-warning'}">${req.payment_status}</span></td>
                        <td><strong>₱${parseFloat(req.total_cost).toFixed(2)}</strong></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewRequest(${req.lab_request_id})" title="View">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="showUpdateModal(${req.lab_request_id}, '${req.status}', '${req.payment_status}', '${req.priority}')" title="Update">
                                <i class="bi bi-pencil"></i>
                            </button>
                            ${req.status !== 'completed' ? `
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRequest(${req.lab_request_id}, '${escapeHtml(req.request_no)}')" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Show Add Modal
        async function showAddModal() {
            selectedTests.clear();
            document.getElementById('requestForm').reset();
            document.getElementById('totalCost').value = '₱0.00';
            updateSelectedTestsDisplay();
            
            await Promise.all([
                loadPatients(),
                loadDoctors(),
                loadTests()
            ]);
            
            new bootstrap.Modal(document.getElementById('requestModal')).show();
        }

        // Load Patients
        async function loadPatients() {
            try {
                const response = await axios.get(PATIENTS_API, {
                    params: { operation: 'getAll', json: JSON.stringify({ limit: 1000 }) }
                });

                if (response.data.success) {
                    const select = document.getElementById('patientSelect');
                    select.innerHTML = '<option value="">Select Patient</option>' +
                        response.data.data.map(p => 
                            `<option value="${p.patient_id}">${escapeHtml(p.first_name + ' ' + p.last_name)} (${escapeHtml(p.patient_code)})</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Error loading patients:', error);
            }
        }

        // Load Doctors
        async function loadDoctors() {
            try {
                const response = await axios.get(DOCTORS_API, {
                    params: { operation: 'getAll', json: JSON.stringify({ limit: 1000 }) }
                });

                if (response.data.success) {
                    const select = document.getElementById('doctorSelect');
                    select.innerHTML = '<option value="">Select Doctor</option>' +
                        response.data.data.map(d => 
                            `<option value="${d.doctor_id}">${escapeHtml(d.full_name)} - ${escapeHtml(d.specialization || 'General')}</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Error loading doctors:', error);
            }
        }

        // Load Tests
        async function loadTests() {
            try {
                const response = await axios.get(TESTS_API, {
                    params: { operation: 'getAll', json: JSON.stringify({ status: 'active', limit: 1000 }) }
                });

                if (response.data.success) {
                    allTests = response.data.data;
                    renderTestsCheckboxes(allTests);
                }
            } catch (error) {
                console.error('Error loading tests:', error);
            }
        }

        // Render Tests Checkboxes
        function renderTestsCheckboxes(tests) {
            const container = document.getElementById('testsContainer');
            
            if (tests.length === 0) {
                container.innerHTML = '<p class="text-muted">No active tests available</p>';
                return;
            }

            container.innerHTML = tests.map(test => `
                <div class="form-check">
                    <input class="form-check-input test-checkbox" type="checkbox" 
                           value="${test.lab_test_id}" 
                           id="test_${test.lab_test_id}"
                           data-name="${escapeHtml(test.test_name)}"
                           data-code="${escapeHtml(test.test_code)}"
                           data-price="${test.price}"
                           onchange="toggleTest(this)">
                    <label class="form-check-label" for="test_${test.lab_test_id}">
                        <strong>${escapeHtml(test.test_code)}</strong> - ${escapeHtml(test.test_name)}
                        <span class="badge bg-primary ms-2">₱${parseFloat(test.price).toFixed(2)}</span>
                        ${test.sample_type ? `<small class="text-muted d-block">${escapeHtml(test.sample_type)}</small>` : ''}
                    </label>
                </div>
            `).join('');
        }

        // Filter Tests
        function filterTests() {
            const search = document.getElementById('testSearch').value.toLowerCase();
            const filtered = allTests.filter(test => 
                test.test_code.toLowerCase().includes(search) ||
                test.test_name.toLowerCase().includes(search) ||
                (test.sample_type && test.sample_type.toLowerCase().includes(search))
            );
            renderTestsCheckboxes(filtered);
            
            // Restore checked state
            selectedTests.forEach(id => {
                const checkbox = document.getElementById(`test_${id}`);
                if (checkbox) checkbox.checked = true;
            });
        }

        // Toggle Test Selection
        function toggleTest(checkbox) {
            const testId = parseInt(checkbox.value);
            
            if (checkbox.checked) {
                selectedTests.add(testId);
            } else {
                selectedTests.delete(testId);
            }
            
            updateSelectedTestsDisplay();
            updateTotalCost();
        }

        // Update Selected Tests Display
        function updateSelectedTestsDisplay() {
            const container = document.getElementById('selectedTests');
            const count = document.getElementById('selectedCount');
            
            count.textContent = selectedTests.size;
            
            if (selectedTests.size === 0) {
                container.innerHTML = '<p class="text-muted">No tests selected</p>';
                return;
            }

            const selectedList = allTests.filter(t => selectedTests.has(t.lab_test_id));
            container.innerHTML = selectedList.map(test => `
                <div class="test-item">
                    <strong>${escapeHtml(test.test_code)}</strong> - ${escapeHtml(test.test_name)}
                    <span class="badge bg-primary float-end">₱${parseFloat(test.price).toFixed(2)}</span>
                </div>
            `).join('');
        }

        // Update Total Cost
        function updateTotalCost() {
            const selectedList = allTests.filter(t => selectedTests.has(t.lab_test_id));
            const total = selectedList.reduce((sum, test) => sum + parseFloat(test.price), 0);
            document.getElementById('totalCost').value = '₱' + total.toFixed(2);
        }

        // Save Request
        async function saveRequest() {
            const patientId = document.getElementById('patientSelect').value;
            const doctorId = document.getElementById('doctorSelect').value;
            
            if (!patientId || !doctorId) {
                showAlert('Please select patient and doctor', 'warning');
                return;
            }
            
            if (selectedTests.size === 0) {
                showAlert('Please select at least one test', 'warning');
                return;
            }

            const data = {
                admin_user_id: user.user_id,
                patient_id: patientId,
                doctor_id: doctorId,
                priority: document.getElementById('prioritySelect').value,
                payment_status: document.getElementById('paymentSelect').value,
                remarks: document.getElementById('remarks').value,
                tests: Array.from(selectedTests)
            };

            try {
                const response = await axios.post(API_URL, null, {
                    params: {
                        operation: 'create',
                        json: JSON.stringify(data)
                    }
                });

                if (response.data.success) {
                    showAlert(response.data.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('requestModal')).hide();
                    loadRequests();
                    loadStatistics();
                } else {
                    showAlert(response.data.error, 'danger');
                }
            } catch (error) {
                showAlert('Error creating request: ' + error.message, 'danger');
            }
        }

        // View Request
        async function viewRequest(id) {
            const modal = new bootstrap.Modal(document.getElementById('viewModal'));
            modal.show();
            
            try {
                const response = await axios.get(API_URL, {
                    params: {
                        operation: 'getById',
                        json: JSON.stringify({ lab_request_id: id })
                    }
                });

                if (response.data.success) {
                    renderRequestDetails(response.data.data);
                }
            } catch (error) {
                document.getElementById('viewModalBody').innerHTML = '<p class="text-danger">Error loading request details</p>';
            }
        }

        // Render Request Details
        function renderRequestDetails(req) {
            const html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Request Information</h6>
                        <table class="table table-sm">
                            <tr><th>Request #:</th><td>${escapeHtml(req.request_no)}</td></tr>
                            <tr><th>Status:</th><td><span class="badge badge-${req.status}">${req.status}</span></td></tr>
                            <tr><th>Priority:</th><td><span class="badge ${req.priority === 'urgent' ? 'badge-urgent' : 'badge-secondary'}">${req.priority}</span></td></tr>
                            <tr><th>Payment:</th><td><span class="badge ${req.payment_status === 'paid' ? 'bg-success' : 'bg-warning'}">${req.payment_status}</span></td></tr>
                            <tr><th>Total Cost:</th><td><strong>₱${parseFloat(req.total_cost).toFixed(2)}</strong></td></tr>
                            <tr><th>Date Requested:</th><td>${formatDateTime(req.date_requested)}</td></tr>
                            ${req.date_completed ? `<tr><th>Date Completed:</th><td>${formatDateTime(req.date_completed)}</td></tr>` : ''}
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Patient Information</h6>
                        <table class="table table-sm">
                            <tr><th>Name:</th><td>${escapeHtml(req.patient_name)}</td></tr>
                            <tr><th>Code:</th><td>${escapeHtml(req.patient_code)}</td></tr>
                            <tr><th>Gender:</th><td>${escapeHtml(req.gender)}</td></tr>
                            <tr><th>DOB:</th><td>${req.date_of_birth}</td></tr>
                        </table>
                        <h6>Doctor</h6>
                        <p><strong>${escapeHtml(req.doctor_name)}</strong><br>
                        <small>${escapeHtml(req.specialization || '')}</small></p>
                        ${req.requested_by_name ? `<p><small>Requested by: ${escapeHtml(req.requested_by_name)}</small></p>` : ''}
                    </div>
                </div>
                ${req.remarks ? `<div class="alert alert-info"><strong>Remarks:</strong> ${escapeHtml(req.remarks)}</div>` : ''}
                <h6 class="mt-3">Lab Tests</h6>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Test Code</th>
                            <th>Test Name</th>
                            <th>Status</th>
                            <th>Result</th>
                            <th>Price</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${req.items.map(item => `
                            <tr>
                                <td>${escapeHtml(item.test_code)}</td>
                                <td>${escapeHtml(item.test_name)}</td>
                                <td><span class="badge badge-${item.status}">${item.status}</span></td>
                                <td>${item.result ? escapeHtml(item.result) : '-'}</td>
                                <td>₱${parseFloat(item.price).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('viewModalBody').innerHTML = html;
        }

        // Show Update Modal
        function showUpdateModal(id, status, payment, priority) {
            document.getElementById('updateRequestId').value = id;
            document.getElementById('updateStatus').value = status;
            document.getElementById('updatePayment').value = payment;
            document.getElementById('updatePriority').value = priority;
            new bootstrap.Modal(document.getElementById('updateModal')).show();
        }

        // Update Request Status
        async function updateRequestStatus() {
            const id = document.getElementById('updateRequestId').value;
            const data = {
                admin_user_id: user.user_id,
                lab_request_id: id,
                status: document.getElementById('updateStatus').value,
                payment_status: document.getElementById('updatePayment').value,
                priority: document.getElementById('updatePriority').value
            };

            try {
                const response = await axios.post(API_URL, null, {
                    params: {
                        operation: 'update',
                        json: JSON.stringify(data)
                    }
                });

                if (response.data.success) {
                    showAlert(response.data.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('updateModal')).hide();
                    loadRequests();
                    loadStatistics();
                } else {
                    showAlert(response.data.error, 'danger');
                }
            } catch (error) {
                showAlert('Error updating request: ' + error.message, 'danger');
            }
        }

        // Delete Request
        async function deleteRequest(id, requestNo) {
            if (!confirm(`Delete request ${requestNo}?`)) return;

            try {
                const response = await axios.post(API_URL, null, {
                    params: {
                        operation: 'delete',
                        json: JSON.stringify({
                            lab_request_id: id,
                            admin_user_id: user.user_id
                        })
                    }
                });

                if (response.data.success) {
                    showAlert(response.data.message, 'success');
                    loadRequests();
                    loadStatistics();
                } else {
                    showAlert(response.data.error, 'danger');
                }
            } catch (error) {
                showAlert('Error deleting request: ' + error.message, 'danger');
            }
        }

        // Render Pagination
        function renderPagination(total, page, limit) {
            const totalPages = Math.ceil(total / limit);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = `<li class="page-item ${page === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${page - 1}); return false;">Previous</a>
            </li>`;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= page - 2 && i <= page + 2)) {
                    html += `<li class="page-item ${i === page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                    </li>`;
                } else if (i === page - 3 || i === page + 3) {
                    html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            html += `<li class="page-item ${page === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${page + 1}); return false;">Next</a>
            </li>`;

            pagination.innerHTML = html;
        }

        function changePage(page) {
            currentPage = page;
            loadRequests();
        }

        // Utility Functions
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }
    </script>
</body>
</html>
