<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Settings Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="bx bx-hospital me-2"></i>
                            Hospital Information Settings
                        </h4>
                        <p class="mb-0 mt-2">Configure hospital information used in patient emails and system branding</p>
                    </div>
                    <div class="card-body">
                        <form id="hospitalSettingsForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        <i class="bx bx-buildings me-1"></i>Hospital/Clinic Name <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="hospital_name" name="hospital_name" required 
                                           placeholder="Enter hospital/clinic name">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        <i class="bx bx-phone me-1"></i>Phone Number <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="hospital_phone" name="hospital_phone" required 
                                           placeholder="+1 (555) 123-4567">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">
                                        <i class="bx bx-map me-1"></i>Complete Address <span class="text-danger">*</span>
                                    </label>
                                    <textarea class="form-control" id="hospital_address" name="hospital_address" rows="2" required 
                                              placeholder="123 Healthcare St, Medical City, State 12345"></textarea>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        <i class="bx bx-globe me-1"></i>Website URL
                                    </label>
                                    <input type="url" class="form-control" id="hospital_website" name="hospital_website" 
                                           placeholder="https://yourhospital.com">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        <i class="bx bx-envelope me-1"></i>Contact Email
                                    </label>
                                    <input type="email" class="form-control" id="hospital_email" name="hospital_email" 
                                           placeholder="info@yourhospital.com">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        <i class="bx bx-fax me-1"></i>Fax Number
                                    </label>
                                    <input type="text" class="form-control" id="hospital_fax" name="hospital_fax" 
                                           placeholder="+1 (555) 123-4568">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        <i class="bx bx-image me-1"></i>Logo URL/Path
                                    </label>
                                    <input type="text" class="form-control" id="hospital_logo_url" name="hospital_logo_url" 
                                           placeholder="/cms/assets/images/hospital-logo.png">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">
                                        <i class="bx bx-info-circle me-1"></i>Hospital Description
                                    </label>
                                    <textarea class="form-control" id="hospital_description" name="hospital_description" rows="2" 
                                              placeholder="Brief description of your hospital/clinic"></textarea>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <div>
                                    <button type="button" class="btn btn-outline-primary" id="loadCurrentBtn">
                                        <i class="bx bx-refresh me-1"></i>Load Current Settings
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="testEmailBtn">
                                        <i class="bx bx-envelope me-1"></i>Test Email
                                    </button>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-outline-secondary" id="resetBtn">
                                        <i class="bx bx-reset me-1"></i>Reset
                                    </button>
                                    <button type="submit" class="btn btn-success" id="saveBtn">
                                        <i class="bx bx-save me-1"></i>Save Settings
                                    </button>
                                </div>
                            </div>
                        </form>

                        <hr class="my-4">

                        <div class="alert alert-info">
                            <h6><i class="bx bx-info-circle me-2"></i>Information</h6>
                            <ul class="mb-0">
                                <li>These settings are used in patient registration emails</li>
                                <li>Make sure to run the database migration first: <code>add_hospital_settings.sql</code></li>
                                <li>Changes take effect immediately for new emails</li>
                                <li>Use the "Test Email" button to preview how emails will look</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '../backend/';

        // Load current settings when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentSettings();
        });

        // Load current settings from database
        async function loadCurrentSettings() {
            try {
                const response = await axios.post(API_BASE + 'system_settings.php', 
                    new URLSearchParams({ operation: 'all' })
                );

                if (response.data.success) {
                    const settings = response.data.data;
                    
                    // Populate form fields
                    document.getElementById('hospital_name').value = settings.hospital_name || '';
                    document.getElementById('hospital_address').value = settings.hospital_address || '';
                    document.getElementById('hospital_phone').value = settings.hospital_phone || '';
                    document.getElementById('hospital_website').value = settings.hospital_website || '';
                    document.getElementById('hospital_email').value = settings.hospital_email || '';
                    document.getElementById('hospital_fax').value = settings.hospital_fax || '';
                    document.getElementById('hospital_description').value = settings.hospital_description || '';
                    document.getElementById('hospital_logo_url').value = settings.hospital_logo_url || '';
                } else {
                    console.log('No settings found, using defaults');
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                Swal.fire({
                    icon: 'warning',
                    title: 'Could not load current settings',
                    text: 'You may need to run the database migration first.'
                });
            }
        }

        // Save settings
        document.getElementById('hospitalSettingsForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';

            try {
                const formData = new FormData(this);
                const settings = {};
                
                for (let [key, value] of formData.entries()) {
                    settings[key] = value;
                }

                const response = await axios.post(API_BASE + 'system_settings.php', 
                    new URLSearchParams({ 
                        operation: 'update',
                        json: JSON.stringify(settings)
                    })
                );

                if (response.data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Settings Saved!',
                        text: 'Hospital information has been updated successfully.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    throw new Error(response.data.error || 'Failed to save settings');
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Save Failed',
                    text: error.message || 'Could not save settings. Please try again.'
                });
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="bx bx-save me-1"></i>Save Settings';
            }
        });

        // Load current button
        document.getElementById('loadCurrentBtn').addEventListener('click', loadCurrentSettings);

        // Reset form
        document.getElementById('resetBtn').addEventListener('click', function() {
            document.getElementById('hospitalSettingsForm').reset();
        });

        // Test email button
        document.getElementById('testEmailBtn').addEventListener('click', function() {
            window.open('../backend/test-email.php', '_blank');
        });
    </script>
</body>
</html>
